
@{
    ViewBag.Title = "Kiosk";
}


<h2>Self-Service Check-Out Kiosk</h2>

<br />
<br />


<div id="errorMessage" class="field-validation-error" style="margin: 2rem; display: none; font-weight: bold; text-align: center;">Invalid barcode, please try again.</div>



<section id="scanYourIdSection" style="display: flex; flex-direction: column; align-items: center;">
    <h3>Please scan your library card</h3>
    <p><em>*Or type in your barcode</em></p>

    @using (Html.BeginForm("KioskUserBarcode", "Home", FormMethod.Post, new { id = "userBarcodeForm" }))
    {
        @Html.AntiForgeryToken()
        <div class="input-group">
            <input type="text" id="userBarcodeInput" name="userBarcode" value="" placeholder="Library Card Barcode" class="form-control" autofocus />
            <div class="input-group-btn">
                <button class="btn btn-default" type="submit"><i class="glyphicon glyphicon-arrow-right"></i></button>
            </div>
        </div>
    }



</section>



<section id="scanYourBookSection" style="display: none; flex-direction: column; align-items: center; opacity: 0;">
    <h3 id="greetingUser"></h3>
    <br />

    <h3>Please scan your books</h3>
    <p><em>*Or type in the barcodes</em></p>

    @using (Html.BeginForm("KioskBookBarcode", "Home", FormMethod.Post, new { id = "bookBarcodeForm" }))
    {
        @Html.AntiForgeryToken()
        <div class="input-group">
            <input type="text" id="bookBarcodeInput" name="bookBarcode" value="" placeholder="Book Barcode" class="form-control" autofocus />
            <div class="input-group-btn">
                <button class="btn btn-default" type="submit"><i class="glyphicon glyphicon-arrow-right"></i></button>
            </div>
        </div>
    }



</section>




<br />
<br />




@section Scripts {
    <script type="text/javascript">
        $(document).ready(function () {
            let userId = "";

            // When the userBarcodeForm is submitted (meaning they scanned their library card) stop the form submission
            // and send it off to the controller ourselves.
            $("#userBarcodeForm").submit(e => {
                e.preventDefault();
                $("#errorMessage").hide(500);
                $.ajax({
                    type: "POST",
                    url: "/Home/KioskUserBarcode",
                    data: {
                        __RequestVerificationToken: getAntiForgeryToken(),
                        userBarcode: $("#userBarcodeInput").val()
                    },
                    dataType: 'json',
                    contentType: 'application/x-www-form-urlencoded; charset=utf-8'
                }).then(res => {
                    // The server liked the barcode, greet them and prompt them to scan their books
                    userId = res.userId;
                    $("#scanYourIdSection").hide(500);
                    $("#greetingUser").text("Hello " + res.fullName);
                    $("#scanYourBookSection").css({ "display": "flex" });
                    $("#scanYourBookSection").animate({ "opacity": 1 }, 500);
                    // TODO: Show list of currently checked out books and their due dates
                    $("#bookBarcodeInput").focus();
                }).fail(err => {
                    // Server didn't like that barcode, log the error and show an error message.
                    console.log('Err is:');
                    console.log(err);
                    $("#errorMessage").show(500);
                });
            });

            // When the bookBarcodeForm is submitted (meaning they scanned a book) stop the form submission
            // and send it off to the controller ourselves.
            $("#bookBarcodeForm").submit(e => {
                e.preventDefault();
                $("#errorMessage").hide(500);
                $.ajax({
                    type: "POST",
                    url: "/Home/KioskBookBarcode",
                    data: {
                        __RequestVerificationToken: getAntiForgeryToken(),
                        userId: userId,
                        bookBarcode: $("#bookBarcodeInput").val()
                    },
                    dataType: 'json',
                    contentType: 'application/x-www-form-urlencoded; charset=utf-8'
                }).then(res => {
                    // The server liked the barcode, greet them and prompt them to scan their books
                    console.log('res is:');
                    console.log(res);
                }).fail(err => {
                    // Server didn't like that barcode, log the error and show an error message.
                    console.log('Err is:');
                    console.log(err);
                    $("#errorMessage").show(500);
                });
            });





            function getAntiForgeryToken() {
                var token = '@Html.AntiForgeryToken()';
                token = $(token).val();
                return token;
            }

        });
    </script>
}